<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>izakaya-relay</title>
</head>
<body>writing...</body>

<script>
  const DB   = "https://izakayaorder-default-rtdb.firebaseio.com";
  const BASE = "https://thunkable.site/w/04B1h--YNF8YZthXS2grH";

  const params = new URLSearchParams(location.search);
  const shop  = params.get("shop");
  const table = params.get("table");
  const token = params.get("token");

  if (!shop || !table || !token) {
    document.body.innerHTML = "missing params: shop/table/token";
    throw new Error("missing params");
  }

  // ① tables に token（今まで通り）
  const urlTables = `${DB}/shops/${shop}/tables/${table}.json`;

  // ② sessions に {shop, table}（追加）
  const urlSession = `${DB}/sessions/${token}.json`;

  Promise.all([
    fetch(urlTables, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(token)
    }),
    fetch(urlSession, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shop: shop, table: table })
    })
  ])
  .then(() => {
    // ③ Thunkableへは token だけ渡す（shop/table不要）
    location.replace(`${BASE}?token=${encodeURIComponent(token)}`);
  })
  .catch((e) => {
    document.body.innerHTML = "ERROR: " + e;
  });
</script>
</html>
